{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: !0\n}), exports.getWatchPath = getWatchPath, exports.getQueryIdFromPath = getQueryIdFromPath, exports.setWatcher = setWatcher, exports.getWatcherCount = getWatcherCount, exports.unsetWatcher = unsetWatcher, exports.applyParamsToQuery = applyParamsToQuery, exports.orderedFromSnapshot = orderedFromSnapshot, exports.populateAndDispatch = populateAndDispatch;\n\nvar _isString2 = _interopRequireDefault(require(\"lodash/isString\")),\n    _size2 = _interopRequireDefault(require(\"lodash/size\")),\n    _forEach2 = _interopRequireDefault(require(\"lodash/forEach\")),\n    _isNaN2 = _interopRequireDefault(require(\"lodash/isNaN\")),\n    _constants = require(\"../constants\"),\n    _populate = require(\"./populate\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction tryParseToNumber(value) {\n  var result = +value;\n  return (0, _isNaN2.default)(result) ? value : result;\n}\n\nfunction getWatchPath(event, path) {\n  if (!event || \"\" === event || !path) throw new Error(\"Event and path are required\");\n  return \"\".concat(event, \":\").concat(\"/\" === path.substring(0, 1) ? \"\" : \"/\").concat(path);\n}\n\nfunction getQueryIdFromPath(path, event) {\n  if (!(0, _isString2.default)(path)) throw new Error(\"Query path must be a string\");\n  var origPath = path,\n      pathSplitted = path.split(\"#\");\n  path = pathSplitted[0];\n  var isQuery = 1 < pathSplitted.length,\n      queryParams = isQuery ? pathSplitted[1].split(\"&\") : [],\n      queryId = isQuery ? queryParams.map(function (param) {\n    var splittedParam = param.split(\"=\");\n    if (\"queryId\" === splittedParam[0]) return splittedParam[1];\n  }).filter(function (q) {\n    return q;\n  }) : void 0;\n  return queryId && 0 < queryId.length ? event ? \"\".concat(event, \":/\").concat(queryId) : queryId[0] : isQuery ? origPath : void 0;\n}\n\nfunction setWatcher(firebase, dispatch, event, path, queryId) {\n  var id = queryId || getQueryIdFromPath(path, event) || getWatchPath(event, path);\n  return firebase._.watchers[id] ? firebase._.watchers[id]++ : firebase._.watchers[id] = 1, dispatch({\n    type: _constants.actionTypes.SET_LISTENER,\n    path: path,\n    payload: {\n      id: id\n    }\n  }), firebase._.watchers[id];\n}\n\nfunction getWatcherCount(firebase, event, path, queryId) {\n  var id = queryId || getQueryIdFromPath(path, event) || getWatchPath(event, path);\n  return firebase._.watchers[id];\n}\n\nfunction unsetWatcher(firebase, dispatch, event, path, queryId) {\n  var id = queryId || getQueryIdFromPath(path, event) || getWatchPath(event, path);\n  path = path.split(\"#\")[0];\n  var watchers = firebase._.watchers;\n  1 >= watchers[id] ? (delete watchers[id], \"first_child\" !== event && \"once\" !== event && firebase.database().ref().child(path).off(event)) : watchers[id] && watchers[id]--, dispatch({\n    type: _constants.actionTypes.UNSET_LISTENER,\n    path: path,\n    payload: {\n      id: id\n    }\n  });\n}\n\nfunction applyParamsToQuery(queryParams, query) {\n  var doNotParse = !1;\n  return queryParams && queryParams.forEach(function (param) {\n    switch (param = param.split(\"=\"), param[0]) {\n      case \"orderByValue\":\n        query = query.orderByValue(), doNotParse = !0;\n        break;\n\n      case \"orderByPriority\":\n        query = query.orderByPriority(), doNotParse = !0;\n        break;\n\n      case \"orderByKey\":\n        query = query.orderByKey(), doNotParse = !0;\n        break;\n\n      case \"orderByChild\":\n        query = query.orderByChild(param[1]);\n        break;\n\n      case \"limitToFirst\":\n        query = query.limitToFirst(parseInt(param[1], 10));\n        break;\n\n      case \"limitToLast\":\n        query = query.limitToLast(parseInt(param[1], 10));\n        break;\n\n      case \"notParsed\":\n        doNotParse = !0;\n        break;\n\n      case \"parsed\":\n        doNotParse = !1;\n        break;\n\n      case \"equalTo\":\n        var equalToParam = doNotParse ? param[1] : tryParseToNumber(param[1]);\n        equalToParam = \"null\" === equalToParam ? null : equalToParam, equalToParam = \"false\" !== equalToParam && equalToParam, equalToParam = \"true\" === equalToParam || equalToParam, query = 3 === param.length ? query.equalTo(equalToParam, param[2]) : query.equalTo(equalToParam);\n        break;\n\n      case \"startAt\":\n        var startAtParam = doNotParse ? param[1] : tryParseToNumber(param[1]);\n        startAtParam = \"null\" === startAtParam ? null : startAtParam, query = 3 === param.length ? query.startAt(startAtParam, param[2]) : query.startAt(startAtParam);\n        break;\n\n      case \"endAt\":\n        var endAtParam = doNotParse ? param[1] : tryParseToNumber(param[1]);\n        endAtParam = \"null\" === endAtParam ? null : endAtParam, query = 3 === param.length ? query.endAt(endAtParam, param[2]) : query.endAt(endAtParam);\n    }\n  }), query;\n}\n\nfunction orderedFromSnapshot(snap) {\n  if (snap.hasChildren && !snap.hasChildren()) return null;\n  var ordered = [];\n  return snap.forEach && snap.forEach(function (child) {\n    ordered.push({\n      key: child.key,\n      value: child.val()\n    });\n  }), (0, _size2.default)(ordered) ? ordered : null;\n}\n\nfunction populateAndDispatch(firebase, dispatch, config) {\n  var data = config.data,\n      populates = config.populates,\n      snapshot = config.snapshot,\n      path = config.path,\n      storeAs = config.storeAs;\n  return (0, _populate.promisesForPopulate)(firebase, snapshot.key, data, populates).then(function (results) {\n    return (0, _forEach2.default)(results, function (result, path) {\n      dispatch({\n        type: _constants.actionTypes.MERGE,\n        path: path,\n        data: result\n      });\n    }), dispatch({\n      type: _constants.actionTypes.SET,\n      path: storeAs || path,\n      data: data,\n      ordered: orderedFromSnapshot(snapshot)\n    }), results;\n  }).catch(function (err) {\n    return dispatch({\n      type: _constants.actionTypes.ERROR,\n      payload: err\n    }), Promise.reject(err);\n  });\n}","map":null,"metadata":{},"sourceType":"script"}