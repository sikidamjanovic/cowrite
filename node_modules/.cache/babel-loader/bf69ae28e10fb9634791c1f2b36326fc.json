{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: !0\n}), exports.getLoginMethodAndParams = getLoginMethodAndParams, exports.authIsReady = authIsReady, exports.createAuthIsReady = createAuthIsReady, exports.updateProfileOnRTDB = updateProfileOnRTDB, exports.updateProfileOnFirestore = updateProfileOnFirestore, exports.setupPresence = setupPresence;\n\nvar _isFunction2 = _interopRequireDefault(require(\"lodash/isFunction\")),\n    _isString2 = _interopRequireDefault(require(\"lodash/isString\")),\n    _isArray2 = _interopRequireDefault(require(\"lodash/isArray\")),\n    _capitalize2 = _interopRequireDefault(require(\"lodash/capitalize\")),\n    _constants = require(\"../constants\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction createAuthProvider(firebase, providerName, scopes) {\n  var capitalProviderName = \"\".concat((0, _capitalize2.default)(providerName), \"AuthProvider\");\n  if (!firebase.auth[capitalProviderName]) throw new Error(\"\".concat(providerName, \" is not a valid auth provider for your firebase instance. If using react-native, use a RN specific auth library.\"));\n  var provider = new firebase.auth[capitalProviderName](),\n      customAuthParameters = firebase._.config.customAuthParameters;\n  return (customAuthParameters && customAuthParameters[providerName] && provider.setCustomParameters(customAuthParameters[providerName]), \"twitter\" === providerName.toLowerCase() || !(0, _isFunction2.default)(provider.addScope)) ? provider : (provider.addScope(\"email\"), scopes && ((0, _isArray2.default)(scopes) && scopes.forEach(function (scope) {\n    provider.addScope(scope);\n  }), (0, _isString2.default)(scopes) && provider.addScope(scopes)), provider);\n}\n\nfunction getLoginMethodAndParams(firebase, creds) {\n  var email = creds.email,\n      password = creds.password,\n      provider = creds.provider,\n      type = creds.type,\n      token = creds.token,\n      scopes = creds.scopes,\n      phoneNumber = creds.phoneNumber,\n      applicationVerifier = creds.applicationVerifier,\n      credential = creds.credential;\n\n  if (credential) {\n    var credentialAuth = firebase.auth().signInAndRetrieveDataWithCredential;\n    return credentialAuth ? {\n      method: \"signInAndRetrieveDataWithCredential\",\n      params: [credential]\n    } : {\n      method: \"signInWithCredential\",\n      params: [credential]\n    };\n  }\n\n  if (provider) {\n    if (-1 === _constants.supportedAuthProviders.indexOf(provider.toLowerCase())) throw new Error(\"\".concat(provider, \" is not a valid Auth Provider\"));\n    if (token) throw new Error(\"provider with token no longer supported, use credential parameter instead\");\n    var authProvider = createAuthProvider(firebase, provider, scopes);\n    return \"popup\" === type ? {\n      method: \"signInWithPopup\",\n      params: [authProvider]\n    } : {\n      method: \"signInWithRedirect\",\n      params: [authProvider]\n    };\n  }\n\n  if (token) {\n    var tokenAuth = firebase.auth().signInAndRetrieveDataWithCustomToken;\n    return tokenAuth ? {\n      method: \"signInAndRetrieveDataWithCustomToken\",\n      params: [token]\n    } : {\n      method: \"signInWithCustomToken\",\n      params: [token]\n    };\n  }\n\n  if (phoneNumber) {\n    if (!applicationVerifier) throw new Error(\"Application verifier is required for phone authentication\");\n    return {\n      method: \"signInWithPhoneNumber\",\n      params: [phoneNumber, applicationVerifier]\n    };\n  }\n\n  return firebase.auth().signInWithEmailAndPassword ? {\n    method: \"signInWithEmailAndPassword\",\n    params: [email, password]\n  } : {\n    method: \"signInAndRetrieveDataWithEmailAndPassword\",\n    params: [email, password]\n  };\n}\n\nfunction isAuthReady(store, stateName) {\n  var state = store.getState(),\n      firebaseState = stateName ? state[stateName] : state,\n      firebaseAuthState = firebaseState && firebaseState.auth;\n  if (!firebaseAuthState) throw new Error(\"The Firebase auth state could not be found in the store under the attribute '\".concat(stateName ? \"\".concat(stateName, \".\") : \"\", \"auth'. Make sure your react-redux-firebase reducer is correctly set in the store\"));\n  return firebaseState.auth.isLoaded;\n}\n\nfunction authIsReady(store) {\n  var stateName = 1 < arguments.length && arguments[1] !== void 0 ? arguments[1] : \"firebase\";\n  return new Promise(function (resolve) {\n    if (isAuthReady(store, stateName)) resolve();else var unsubscribe = store.subscribe(function () {\n      isAuthReady(store, stateName) && (unsubscribe(), resolve());\n    });\n  });\n}\n\nfunction createAuthIsReady(store, config) {\n  return (0, _isFunction2.default)(config.authIsReady) ? config.authIsReady(store, config) : authIsReady(store, config.firebaseStateName);\n}\n\nfunction updateProfileOnRTDB(firebase, profileUpdate) {\n  var database = firebase.database,\n      _firebase$_ = firebase._,\n      config = _firebase$_.config,\n      authUid = _firebase$_.authUid,\n      profileRef = database().ref(\"\".concat(config.userProfile, \"/\").concat(authUid));\n  return profileRef.update(profileUpdate).then(function () {\n    return profileRef.once(\"value\");\n  });\n}\n\nfunction updateProfileOnFirestore(firebase, profileUpdate) {\n  var options = 2 < arguments.length && arguments[2] !== void 0 ? arguments[2] : {},\n      _options$useSet = options.useSet,\n      _options$merge = options.merge,\n      firestore = firebase.firestore,\n      _firebase$_2 = firebase._,\n      config = _firebase$_2.config,\n      authUid = _firebase$_2.authUid,\n      profileRef = firestore().doc(\"\".concat(config.userProfile, \"/\").concat(authUid)),\n      profileUpdatePromise = !(void 0 !== _options$useSet) || _options$useSet ? profileRef.set(profileUpdate, {\n    merge: !(void 0 !== _options$merge) || _options$merge\n  }) : profileRef.update(profileUpdate);\n  return profileUpdatePromise.then(function () {\n    return profileRef.get();\n  });\n}\n\nfunction setupPresence(dispatch, firebase) {\n  if (firebase.database && firebase.database.ServerValue) {\n    var ref = firebase.database().ref(),\n        _firebase$_3 = firebase._,\n        _firebase$_3$config = _firebase$_3.config,\n        presence = _firebase$_3$config.presence,\n        sessions = _firebase$_3$config.sessions,\n        authUid = _firebase$_3.authUid,\n        amOnline = ref.child(\".info/connected\"),\n        onlineRef = ref.child((0, _isFunction2.default)(presence) ? presence(firebase.auth().currentUser, firebase) : presence).child(authUid),\n        sessionsRef = (0, _isFunction2.default)(sessions) ? sessions(firebase.auth().currentUser, firebase) : sessions;\n    sessionsRef && (sessionsRef = ref.child(sessions)), amOnline.on(\"value\", function (snapShot) {\n      if (snapShot.val()) {\n        if (sessionsRef) {\n          dispatch({\n            type: _constants.actionTypes.SESSION_START,\n            payload: authUid\n          });\n          var session = sessionsRef.push({\n            startedAt: firebase.database.ServerValue.TIMESTAMP,\n            user: authUid\n          });\n          (0, _isFunction2.default)(session.setPriority) && session.setPriority(authUid), session.child(\"endedAt\").onDisconnect().set(firebase.database.ServerValue.TIMESTAMP, function () {\n            dispatch({\n              type: _constants.actionTypes.SESSION_END\n            });\n          });\n        }\n\n        onlineRef.set(!0), onlineRef.onDisconnect().remove();\n      }\n    });\n  }\n}","map":null,"metadata":{},"sourceType":"script"}